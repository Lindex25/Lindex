name: Deploy to Fly.io

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual triggering

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    # Uncomment below to require manual approval before deployment (recommended for beginners)
    # environment:
    #   name: production
    #   url: https://your-app.fly.dev

    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Validate Required Secrets
        run: |
          echo "Validating required secrets..."

          # Check if FLY_API_TOKEN is set
          if [ -z "${{ secrets.FLY_API_TOKEN }}" ]; then
            echo "::error::FLY_API_TOKEN secret is not set"
            echo "::error::Go to Settings > Secrets > Actions and add FLY_API_TOKEN"
            exit 1
          fi

          # Validate token format (basic check for Fly.io token)
          TOKEN="${{ secrets.FLY_API_TOKEN }}"
          if [[ ! "$TOKEN" =~ ^fo1_[a-zA-Z0-9]{40,}$ ]]; then
            echo "::warning::FLY_API_TOKEN format looks incorrect"
            echo "::warning::Expected format: fo1_<40+ alphanumeric chars>"
            echo "::warning::Proceeding anyway, but deployment may fail"
          fi

          echo "✓ Required secrets are present"

      - name: Set up Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@1a4a8c86317c68b55d6671a07e6c0f8e0e1f3c3e # master

      - name: Deploy to Fly.io
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl deploy --remote-only --ha=false

      - name: Verify deployment
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "Deployment completed!"
          flyctl status

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed. Check logs above."
            exit 1
          fi

      - name: Notify Discord - Success
        if: success() && secrets.DISCORD_WEBHOOK_DEPLOY != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_DEPLOY }}
        run: |
          # Use jq to properly escape JSON values
          PAYLOAD=$(jq -n \
            --arg repo "${{ github.repository }}" \
            --arg branch "${{ github.ref_name }}" \
            --arg commit "${{ github.event.head_commit.message }}" \
            --arg commit_url "${{ github.event.head_commit.url }}" \
            --arg author "${{ github.actor }}" \
            '{
              embeds: [{
                title: "✅ Deployment Successful",
                description: ("**Repository:** " + $repo + "\n**Branch:** " + $branch + "\n**Commit:** [" + $commit + "](" + $commit_url + ")\n**Author:** " + $author + "\n**Environment:** Production (Fly.io)"),
                color: 3066993,
                timestamp: (now | strftime("%Y-%m-%dT%H:%M:%SZ"))
              }]
            }')

          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "$DISCORD_WEBHOOK" || echo "Discord notification failed (non-critical)"

      - name: Notify Discord - Failure
        if: failure() && secrets.DISCORD_WEBHOOK_DEPLOY != ''
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_DEPLOY }}
        run: |
          # Use jq to properly escape JSON values
          PAYLOAD=$(jq -n \
            --arg repo "${{ github.repository }}" \
            --arg branch "${{ github.ref_name }}" \
            --arg commit "${{ github.event.head_commit.message }}" \
            --arg commit_url "${{ github.event.head_commit.url }}" \
            --arg author "${{ github.actor }}" \
            --arg logs_url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            '{
              embeds: [{
                title: "❌ Deployment Failed",
                description: ("**Repository:** " + $repo + "\n**Branch:** " + $branch + "\n**Commit:** [" + $commit + "](" + $commit_url + ")\n**Author:** " + $author + "\n**Workflow:** [View Logs](" + $logs_url + ")"),
                color: 15158332,
                timestamp: (now | strftime("%Y-%m-%dT%H:%M:%SZ"))
              }]
            }')

          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "$DISCORD_WEBHOOK" || echo "Discord notification failed (non-critical)"
