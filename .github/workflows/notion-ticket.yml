name: Create Notion Ticket on Push

on:
  push:
    branches:
      - main
      - master
      - develop
    # Uncomment below to run on all branches
    # branches:
    #   - '**'

jobs:
  create-notion-ticket:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Fetch last 2 commits to get diff info

      - name: Get commit information
        id: commit_info
        run: |
          echo "commit_message=$(git log -1 --pretty=%B | head -n 1)" >> $GITHUB_OUTPUT
          echo "commit_hash=$(git log -1 --pretty=%H)" >> $GITHUB_OUTPUT
          echo "commit_short_hash=$(git log -1 --pretty=%h)" >> $GITHUB_OUTPUT
          echo "author_name=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "author_email=$(git log -1 --pretty=%ae)" >> $GITHUB_OUTPUT
          echo "commit_date=$(git log -1 --pretty=%ci)" >> $GITHUB_OUTPUT
          echo "branch_name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      - name: Create Notion ticket
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          COMMIT_MESSAGE: ${{ steps.commit_info.outputs.commit_message }}
          COMMIT_HASH: ${{ steps.commit_info.outputs.commit_hash }}
          COMMIT_SHORT_HASH: ${{ steps.commit_info.outputs.commit_short_hash }}
          AUTHOR_NAME: ${{ steps.commit_info.outputs.author_name }}
          AUTHOR_EMAIL: ${{ steps.commit_info.outputs.author_email }}
          COMMIT_DATE: ${{ steps.commit_info.outputs.commit_date }}
          BRANCH_NAME: ${{ steps.commit_info.outputs.branch_name }}
          REPO_NAME: ${{ github.repository }}
          COMMIT_URL: ${{ github.event.head_commit.url }}
        run: |
          curl -X POST https://api.notion.com/v1/pages \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            --data @- <<EOF
          {
            "parent": {
              "database_id": "$NOTION_DATABASE_ID"
            },
            "properties": {
              "Title": {
                "title": [
                  {
                    "text": {
                      "content": "$COMMIT_SHORT_HASH: $COMMIT_MESSAGE"
                    }
                  }
                ]
              },
              "Commit Hash": {
                "rich_text": [
                  {
                    "text": {
                      "content": "$COMMIT_HASH"
                    }
                  }
                ]
              },
              "Author": {
                "rich_text": [
                  {
                    "text": {
                      "content": "$AUTHOR_NAME"
                    }
                  }
                ]
              },
              "Branch": {
                "rich_text": [
                  {
                    "text": {
                      "content": "$BRANCH_NAME"
                    }
                  }
                ]
              },
              "Repository": {
                "rich_text": [
                  {
                    "text": {
                      "content": "$REPO_NAME"
                    }
                  }
                ]
              },
              "Commit Link": {
                "url": "$COMMIT_URL"
              },
              "Status": {
                "status": {
                  "name": "Committed"
                }
              }
            }
          }
          EOF

      - name: Workflow completed
        run: echo "âœ… Notion ticket created successfully!"
